<div class="card p-p-3">
  <form [formGroup]="filtroForm" (ngSubmit)="pesquisar()">
    <div class="p-fluid p-formgrid p-grid">
      <div class="p-field p-col-12 p-md-4">
        <label for="nomeFantasia">Nome Fantasia</label>
        <input id="nomeFantasia" type="text" pInputText formControlName="nomeFantasia" />
      </div>
      <div class="p-field p-col-12 p-md-4">
        <label for="razaoSocial">Razão Social</label>
        <input id="razaoSocial" type="text" pInputText formControlName="razaoSocial" />
      </div>
      <div class="p-field p-col-12 p-md-4">
        <label for="email">Email</label>
        <input id="email" type="text" pInputText formControlName="email" />
      </div>
      <div class="p-field p-col-12 p-md-3">
        <label for="estado">Estado</label>
        <p-dropdown formControlName="estado" [options]="estados" optionLabel="descricao"
          placeholder="Selecione um estado">
        </p-dropdown>
      </div>
      <div class="p-field p-col-12 p-md-4">
        <label for="cidade">Cidade</label>
        <p-dropdown formControlName="cidade" [options]="cidades" optionLabel="cNome"
          placeholder="Selecione uma cidade">
        </p-dropdown>
      </div>
      <div class="p-field p-col-12 p-md-2">
        <label for="status">Status</label>
        <p-dropdown formControlName="status" [options]="status" optionLabel="descricao"
          placeholder="Selecione um status" [showClear]="true" [emptyFilterMessage]="'Nenhum status encontrado'">
        </p-dropdown>
      </div>
      <div class="p-field p-col-12 p-md-3">
        <label for="plataforma">Plataforma</label>
        <p-dropdown formControlName="plataforma" [options]="plataforma" optionLabel="descricao"
          placeholder="Selecione uma plataforma" [showClear]="true"
          [emptyFilterMessage]="'Nenhuma plataforma encontrada'">
        </p-dropdown>
      </div>
    </div>

    <div class="flex justify-end gap-3 mt-4">
      <button type="button" (click)="limparFiltro()"
        class="flex items-center gap-2 border border-primary-500 text-primary-500 px-4 py-2 rounded hover:bg-primary-500 hover:text-white transition">
        <i class="pi pi-times"></i>
        Limpar
      </button>

      <button type="submit"
        class="flex items-center gap-2 bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700 transition">
        <i class="pi pi-search"></i>
        Buscar
      </button>
    </div>
  </form>

  <div class="mt-12" #table>
    <p-table [value]="clientes" [paginator]="true" [rows]="rows" [totalRecords]="totalRecords" [lazy]="true"
      (onLazyLoad)="onLazyLoad($event)" [rowsPerPageOptions]="[5,10,20]" [responsiveLayout]="'scroll'"
      [resizableColumns]="true" [sortMode]="'multiple'" [loading]="carregando" [showCurrentPageReport]="true"
      currentPageReportTemplate="Exibindo {first} a {last} de {totalRecords} clientes">
      <ng-template pTemplate="header">
        <tr>
          <th class="!text-left">
            <div class="flex items-center gap-1" pSortableColumn="nomeFantasia">
              Nome Fantasia <p-sortIcon field="nomeFantasia" styleClass="text-sm"></p-sortIcon>
            </div>
          </th>
          <th class="!text-left">
            <div class="flex items-center gap-1" pSortableColumn="email">
              Email <p-sortIcon field="email" styleClass="text-sm"></p-sortIcon>
            </div>
          </th>
          <th class="!text-left">
            <div class="flex items-center gap-1" pSortableColumn="cidade">
              Cidade <p-sortIcon field="cidade" styleClass="text-sm"></p-sortIcon>
            </div>
          </th>
          <th class="!text-left">
            <div class="flex items-center gap-1" pSortableColumn="codigo">
              Plataforma <p-sortIcon field="codigo" styleClass="text-sm"></p-sortIcon>
            </div>
          </th>
          <th class="!text-left">
            <div class="flex items-center gap-1" pSortableColumn="status">
              Status <p-sortIcon field="status" styleClass="text-sm"></p-sortIcon>
            </div>
          </th>
          <th class="!text-left">Ações</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-cliente>
        <tr>
          <td class="max-w-[200px] whitespace-pre-line break-words">{{ cliente.nomeFantasia ?? cliente.nome_fantasia }}</td>
          <td class="max-w-[200px] whitespace-pre-line break-words">{{ cliente.email }}</td>
          <td>{{ cliente.cidade }}</td>
          <td>{{ validacaoCadastro(cliente) }}</td>
          <td>{{ cliente.status }}</td>
          <td class="flex justify-start gap-2">
            <ng-container *ngIf="validacaoCadastro(cliente) == 'Costelata' && cliente.status === 'Ativo'">
              <button pButton icon="pi pi-key" type="button"
                class="p-button p-button-rounded border-none text-primary-500 hover:text-primary-700"
                pTooltip="Reenviar senha de acesso" tooltipPosition="top" (click)="reenviarSenhaAcesso(cliente)">
              </button>
            </ng-container>

            <ng-container *ngIf="validacaoCadastro(cliente) == 'Costelata' && cliente.status === 'Bloqueado'">
              <button pButton icon="pi pi-envelope" type="button"
                class="p-button p-button-rounded border-none text-primary-500 hover:text-primary-700"
                pTooltip="Aprovar Cadastro" tooltipPosition="top" (click)="aprovarCadastro(cliente)">
              </button>
            </ng-container>

            <button pButton icon="pi pi-pencil" type="button"
              class="p-button p-button-rounded border-none text-primary-400 hover:text-primary-600"
              pTooltip="Editar Usuário" tooltipPosition="top" (click)="editar(cliente)">
            </button>

            <ng-container *ngIf="validacaoCadastro(cliente) == 'Costelata'">
              <button pButton [icon]="cliente.status === 'Ativo' ? 'pi pi-eye' : 'pi pi-eye-slash'" type="button"
                class="p-button p-button-rounded border-none text-primary-600 hover:text-primary-500"
                [pTooltip]="cliente.status === 'Ativo' ? 'Bloquear Cliente' : 'Ativar Cliente'" tooltipPosition="top"
                (click)="alterarStatus(cliente)">
              </button>
            </ng-container>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center">Nenhum cliente encontrado.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<p-dialog header="Reenvio de senha provisória" [(visible)]="modalCadastroReenvioSenhaVisivel" [modal]="true"
  [closable]="true" [dismissableMask]="true" [style]="{width: '400px'}">
  <div *ngIf="modalCadastroReenvioSenha" class="flex flex-col gap-2">
    <div class="flex items-center">
      <span class="font-semibold mr-2">Email:</span>
      <span class="break-all">{{ modalCadastroReenvioSenha.email }}</span>
    </div>
    <div class="flex items-center">
      <span class="font-semibold mr-2">Senha provisória:</span>
      <span class="font-bold text-primary-500 bg-primary-50 px-2 py-1 rounded select-all">{{
        modalCadastroReenvioSenha.senhaProvisoria }}</span>
    </div>
    <p-divider></p-divider>
    <p class="text-xs text-gray-500 italic">Obs: Senha provisória válida por 3 dias.</p>
  </div>
</p-dialog>

<p-dialog header="Cadastro Aprovado" [(visible)]="modalCadastroAprovadoVisivel" [modal]="true" [closable]="true"
  [dismissableMask]="true" [style]="{width: '400px'}">
  <div *ngIf="modalCadastroAprovadoUsuario" class="flex flex-col gap-2">
    <div class="flex items-center">
      <span class="font-semibold mr-2">Email:</span>
      <span class="break-all">{{ modalCadastroAprovadoUsuario.email }}</span>
    </div>
    <div class="flex items-center">
      <span class="font-semibold mr-2">Senha provisória:</span>
      <span class="font-bold text-primary-500 bg-primary-50 px-2 py-1 rounded select-all">{{
        modalCadastroAprovadoUsuario.senhaProvisoria }}</span>
    </div>
    <p-divider></p-divider>
    <p class="text-xs text-gray-500 italic">Obs: Senha provisória válida por 3 dias.</p>
  </div>
</p-dialog>

<p-toast></p-toast>