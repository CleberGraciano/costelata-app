name: Deploy para VPS

on:
  push:
    branches:
    - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout código
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # pega todo o histórico, não apenas o último commit

    - name: Enviar código para VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_KEY }}
        source: "api/*,ui/*"
        target: "/var/www/costelata/"

    - name: Conectar na VPS e atualizar containers
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_KEY }}
        script: |
          cd /var/www/costelata
          docker compose up -d --build
          docker image prune -f
